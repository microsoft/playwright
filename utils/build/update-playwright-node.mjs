/**
 * Copyright (c) Microsoft Corporation.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import fs from 'fs';
import url from 'url';
import path from 'path';
import https from 'https';

const currentFilePath = url.fileURLToPath(import.meta.url);
const buildFilePath = path.join(path.dirname(currentFilePath), 'build-playwright-driver.sh');
const dockerDirectory = path.join(path.dirname(currentFilePath), '../docker');
const dockerfilePaths = await getDockerfilePaths(dockerDirectory);

const latestNodeJsLts = await getLatestNodeJsVersion();

if (refreshBuildScriptVersionNumber(latestNodeJsLts, buildFilePath))
  console.log(`Updated build script ${path.relative(process.cwd(), buildFilePath)} to Node.js ${latestNodeJsLts}`);
for (const dockerfilePath of dockerfilePaths) {
  const nodeMajorVersion = latestNodeJsLts.split('.')[0];
  if (refreshDockerfileVersionNumber(nodeMajorVersion, dockerfilePath))
    console.log(`Updated Dockerfile ${path.relative(process.cwd(), dockerfilePath)} to Node.js ${nodeMajorVersion}.x`);
}

async function getDockerfilePaths(directory) {
  const entries = await fs.promises.readdir(directory);
  return entries
    .filter(entry => entry.startsWith('Dockerfile'))
    .map(entry => path.join(directory, entry));
}

function getLatestNodeJsVersion() {
  return new Promise((resolve, reject) => {
    https.get('https://nodejs.org/dist/index.json', res => {
      let content = '';
      res.on('data', chunk => content += chunk);
      res.on('end', () => {
        if (res.statusCode !== 200)
          reject(new Error(`Failed to get nodejs version, status code: ${res.statusCode}`));
        const version = JSON.parse(content);
        const latestLts = version.find(release => release.lts);
        resolve(latestLts.version.slice(1));
      });
    });
  });
}

function replaceVersionInFile(filePath, newNodeJsVersion, replacementRegex) {
  const fileContent = fs.readFileSync(filePath, 'utf8');
  const newFileContent = fileContent.replace(replacementRegex, `$1${newNodeJsVersion}$3`);
  fs.writeFileSync(filePath, newFileContent);
  return fileContent !== newFileContent;
}

function refreshBuildScriptVersionNumber(newNodeJsVersion, buildScriptPath) {
  const replacementRegex = new RegExp(`(NODE_VERSION=")(.*)(" # autogenerated via \\.\/${path.basename(currentFilePath).replace('.', '\\.')})`);
  return replaceVersionInFile(buildScriptPath, newNodeJsVersion, replacementRegex);
}

function refreshDockerfileVersionNumber(newNodeJsVersion, dockerfilePath) {
  const replacementRegex = new RegExp(`(ARG NODE_VERSION=)(.*)( # autogenerated via \\.\/${path.basename(currentFilePath).replace('.', '\\.')})`);
  return replaceVersionInFile(dockerfilePath, newNodeJsVersion, replacementRegex);
}
